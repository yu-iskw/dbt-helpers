{#
    It is a template for a BigQuery table.
    SEE: https://docs.getdbt.com/reference/source-properties/
#}
{%- import "macros.jinja" as macros -%}

# It was generated by dbt-helper=={{ context.dbt_helper_version }}.
version: 2

sources:
  - name: {{ context.dataset }}
    database: "{{ macros.to_raw_expression( macros.get_var_project(context.project_alias) ) }}"
    tables:
{%- for resource in resources %}
      # dbt source ID: `{{- 'source("{}", "{}")'.format(context.dataset, resource.name) -}}`
      - name: {{ resource.name }}
        identifier: {{ resource.meta.get('_extraction_metadata', {}).get('identifier', resource.name) }}

        description: |
          {%- if resource.description %}
          {{ resource.description | indent(width=10, first=False) }}
          {%- else %}
          ## Overview
          Please briefly describe the table/view.
          It would be awesome to include how to create the table too.

          ## Special Notes
          Please describe points to note to use the table/view, if exists.

          ## Example Query
          ```sql
          ...
          ```

          ## Links
          * ...
          * ...
          {%- endif %}

        config:
          {% raw -%}
          # see also https://docs.getdbt.com/reference/resource-properties/freshness
          freshness:
            warn_after:
              count: 24
              period: hour # minute | hour | day
            error_after:
              count: 36
              period: hour # minute | hour | day
            # filter: "DATE(event_time) BETWEEN (CURRENT_DATE() - 1) AND CURRENT_DATE()" # if partition table
          {%- endraw %}

          {%- if resource.tags|length > 0 %}
          tags:
            {%- for tag in resource.tags %}
            - {{ tag }}
            {%- endfor %}
          {%- else %}
          {%- raw %}
          tags: []
          {%- endraw %}
          {%- endif %}

          # meta will be written into BigQuery labels by dbt-helper.
          meta:
            labels:
              {%- set labels = resource.meta %}
              {%- if labels | length > 0 %}
              {%- for k, v in labels.items() %}
              {%- if k != '_extraction_metadata' %}
              {{ k }}: {{ v }}
              {%- endif %}
              {%- endfor %}
              {%- else %}
              owner: "" # hola mention name, e.g. "hola-medico-monshin-engineer-members"
              data_type: "" # type of source data origin (eg. postgres, log, firestore, saas)
              {%- endif %}

            {%- if context.data_objectives is defined and context.data_objectives is not none %}
            data_privacy:
            {%- for data_objective in context.data_objectives %}
            {%- set objective = data_objective.get('objective') %}
            {%- set auth_view_project_alias = data_objective.get('project_alias') %}
            {%- set dbt_main_tag = data_objective.get('dbt_main_tag') %}
            {#- For now, we still use the macro for auth views as they are generated names -#}
            {%- set auth_view_name = macros.generate_reference_id(auth_view_project_alias, context.dataset, resource.name) %}
              # NOTE Please disable it if we want to delete the generated model first to delete the BigQuery table/view.
              - name: "{{- auth_view_name -}}"
                objective: "{{- objective -}}"
                config:
                  enabled: true
                  materialized: view
                  database: var('projects')['{{- auth_view_project_alias -}}']
                  schema: "{{- context.dataset -}}"
                  alias: "{{- resource.name -}}"
                  grant_access_to:
                    - project: var('projects')['{{- context.project_alias -}}']
                      dataset: "{{- context.dataset -}}"
                  {%- if resource.tags|length > 0 %}
                  tags:
                    - '{{- dbt_main_tag -}}'
                  {%- else %}
                  {%- raw %}
                  tags: []
                  {%- endraw %}
                  {%- endif %}
                  labels:
                    modeled_by: "dbt"
                    generated_by: "dbt-data-privacy"
                    {%- if labels | length > 0 %}
                    {%- for k, v in labels.items() %}
                    {%- if k != '_extraction_metadata' %}
                    {{ k }}: "{{ v }}"
                    {%- endif %}
                    {%- endfor %}
                    {%- endif %}
                extra_meta:
                  database_alias: "{{- auth_view_project_alias -}}"
            {%- endfor %}
            {%- endif %}

        columns:
          {%- for column in resource.columns %}
          - name: {{ column.name }}
            {%- if not column.description %}
            description: ""
            {%- else %}
            description: |-
              {{ column.description | indent(width=15, first=False) }}
            {%- endif %}
            {%- if context.data_objectives is defined and context.data_objectives is not none %}
            config:
              meta:
                data_privacy:
                  level: "not_invented" # type of security level (public, internal, confidential, restricted, highly_restricted)
                  policy_tags: []
            {%- endif %}
          {%- endfor %}
{% endfor %}
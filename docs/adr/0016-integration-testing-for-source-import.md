# 16. Integration Testing Strategy for Source Import

Date: 2026-02-16

## Status

Accepted

## Context

As we implement the `source import` functionality, we need a reliable way to verify that the warehouse metadata is correctly extracted and mapped to the dbt project structure. While unit tests cover individual components, integration tests are necessary to ensure the end-to-end flow works correctly with real warehouse instances (or realistic local emulators).

## Decision

We will implement integration tests for the `source import` feature using the following strategy:

1. **Plugin-Level Integration Tests**: Each warehouse plugin will have its own integration tests located in `tests/integration/`.
2. **Containerized Test Environments**: We will use Testcontainers (or existing Docker-based setups) to provide real warehouse instances for testing. For DuckDB, we use a local `.duckdb` file generated by `dbt build` in a containerized or local environment.
3. **Orchestrator-Based Testing**: Instead of just testing the `CatalogClient.read_catalog` method, we will test the `Orchestrator.generate_source_plan` method. This verifies the entire pipeline:
   - Warehouse metadata extraction.
   - IR mapping.
   - Path resolution via `PathPolicy`.
   - Plan generation (Create/Update operations).
4. **Fixture Usage**: We will leverage the `dbt_duckdb_container` fixture to ensure tests run against a known, pre-populated database state.
5. **Comprehensive Coverage**: Tests should cover:
   - Standard table/view extraction.
   - Multiple schemas (if supported by the warehouse).
   - Data type mapping.
   - Idempotency (running the plan generation against an existing state).

## Consequences

- **Increased Confidence**: We can be sure that the `source import` command works correctly with real database schemas.
- **Easier Debugging**: Integration tests provide a reproducible environment for investigating issues in the metadata extraction layer.
- **Maintenance Overhead**: We need to keep the test fixtures (e.g., `sample_project`) in sync with the features we want to test.
- **Slower Test Suite**: Integration tests are inherently slower than unit tests, but by using DuckDB and efficient bulk-fetching, we keep the impact minimal.
